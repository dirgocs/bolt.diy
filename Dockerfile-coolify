# Etapa base
ARG BASE=node:20.18.0-bullseye
FROM ${BASE} AS base

WORKDIR /app

# Força o uso do bash para todos os comandos RUN
SHELL ["/bin/bash", "-c"]

# Copia os arquivos de dependência para aproveitar o cache
COPY package.json pnpm-lock.yaml ./

# Atualiza o npm, instala o Corepack, configura o pnpm e instala o Wrangler
RUN npm install -g npm@latest && \
    npm install -g corepack@latest && \
    corepack enable pnpm && \
    corepack use pnpm@latest-10 && \
    npm cache clean --force && \
    npm uninstall -g wrangler && \
    npm install -g wrangler@latest --force

# Instala as dependências do projeto
RUN pnpm install

# Etapa de build: copia o restante do código, ajusta os scripts e executa o build
FROM base AS build

WORKDIR /app

# Copia o restante do projeto
COPY . .

# Torna o script postdeploy.sh executável
RUN chmod +x postdeploy.sh

# Corrige o formato do bindings.sh e garante sua execução
RUN tr -d '\r' < bindings.sh > bindings.tmp && \
    mv bindings.tmp bindings.sh && \
    chmod +x bindings.sh

# Pré-configura o Wrangler para desativar as métricas
RUN mkdir -p /root/.config/.wrangler && \
    echo '{"enabled":false}' > /root/.config/.wrangler/metrics.json

# Executa o build da aplicação
RUN pnpm run build

# Expondo a porta da aplicação
EXPOSE 5173

# Etapa final: imagem de produção para uso com Coolify
FROM build AS production

# Recebe os argumentos de build para injeção de variáveis de ambiente
ARG SESSION_SECRET
ARG NODE_ENV
ARG RUNNING_IN_DOCKER

# Define as variáveis de ambiente na imagem de produção
ENV NODE_ENV=${NODE_ENV} \
    RUNNING_IN_DOCKER=${RUNNING_IN_DOCKER} \
    SESSION_SECRET=${SESSION_SECRET}

COPY entrypoint.sh /app/entrypoint.sh
RUN chmod +x /app/entrypoint.sh

# Comando final para iniciar a aplicação usando o entrypoint personalizado
CMD ["/app/entrypoint.sh"]
