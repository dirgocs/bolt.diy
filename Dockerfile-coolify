FROM node:20.18.0-bookworm AS base

WORKDIR /app

# Use bash for all RUN commands
SHELL ["/bin/bash", "-c"]

# Install PostgreSQL client and MinIO Client
RUN apt-get update && \
    apt-get install -y postgresql-client mc curl && \
    rm -rf /var/lib/apt/lists/*

# Copy dependency files to utilize cache
COPY package.json pnpm-lock.yaml ./

# Update npm, install Corepack, configure pnpm, and update Wrangler
RUN npm install -g npm@latest && \
    npm install -g corepack@latest && \
    corepack enable pnpm && \
    corepack use pnpm@latest-10 && \
    npm cache clean --force && \
    npm uninstall -g wrangler && \
    npm install -g wrangler@3.112.0 --force

# Install project dependencies
RUN pnpm install

# Build stage
FROM base AS build

WORKDIR /app

# Copy the rest of the project
COPY . .

# Make scripts executable and run setup script during build
RUN chmod +x postdeploy.sh bindings.sh entrypoint.sh coolify-setup.sh && \
    # Fix bindings.sh format
    tr -d '\r' < bindings.sh > bindings.tmp && \
    mv bindings.tmp bindings.sh && \
    # Fix entrypoint.sh format
    tr -d '\r' < entrypoint.sh > entrypoint.tmp && \
    mv entrypoint.tmp entrypoint.sh && \
    # Run setup script during build
    ./coolify-setup.sh

# Pre-configure Wrangler to disable metrics
RUN mkdir -p /root/.config/.wrangler && \
    echo '{"enabled":false}' > /root/.config/.wrangler/metrics.json

# Build the application
RUN pnpm run build

# Create the environment variable injection script
RUN echo '#!/bin/bash' > /app/inject-env-vars.sh && \
    echo 'set -e' >> /app/inject-env-vars.sh && \
    echo 'SERVER_INDEX="./build/server/index.js"' >> /app/inject-env-vars.sh && \
    echo 'if [ -f "$SERVER_INDEX" ]; then' >> /app/inject-env-vars.sh && \
    echo '  echo "Injecting environment variables into server build"' >> /app/inject-env-vars.sh && \
    echo '  # Add environment variable setup to beginning of file' >> /app/inject-env-vars.sh && \
    echo '  sed -i "1s/^/if(typeof globalThis!==\"undefined\"){if(typeof process===\"undefined\")globalThis.process={env:{}};else if(!process.env)process.env={};if(typeof globalThis.env!==\"undefined\"){Object.keys(globalThis.env).forEach(key=>{process.env[key]=globalThis.env[key];});}}\\n/" "$SERVER_INDEX"' >> /app/inject-env-vars.sh && \
    echo '  echo "Successfully injected environment bridge into $SERVER_INDEX"' >> /app/inject-env-vars.sh && \
    echo 'else' >> /app/inject-env-vars.sh && \
    echo '  echo "Warning: $SERVER_INDEX not found"' >> /app/inject-env-vars.sh && \
    echo 'fi' >> /app/inject-env-vars.sh && \
    chmod +x /app/inject-env-vars.sh

# Run the injection script after build
RUN /app/inject-env-vars.sh

# Create the script for direct injection of Supabase credentials
RUN echo '#!/bin/bash' > /app/update-supabase-creds.sh && \
    echo 'set -e' >> /app/update-supabase-creds.sh && \
    echo '' >> /app/update-supabase-creds.sh && \
    echo '# Get the Supabase credentials from the environment' >> /app/update-supabase-creds.sh && \
    echo 'SUPABASE_URL="${SUPABASE_URL}"' >> /app/update-supabase-creds.sh && \
    echo 'SUPABASE_ANON_KEY="${SUPABASE_ANON_KEY}"' >> /app/update-supabase-creds.sh && \
    echo 'SUPABASE_SERVICE_KEY="${SUPABASE_SERVICE_KEY}"' >> /app/update-supabase-creds.sh && \
    echo '' >> /app/update-supabase-creds.sh && \
    echo '# Ensure they'"'"'re provided' >> /app/update-supabase-creds.sh && \
    echo 'if [ -z "$SUPABASE_URL" ] || [ -z "$SUPABASE_ANON_KEY" ]; then' >> /app/update-supabase-creds.sh && \
    echo '  echo "ERROR: Supabase credentials not provided. Please set SUPABASE_URL and SUPABASE_ANON_KEY."' >> /app/update-supabase-creds.sh && \
    echo '  exit 1' >> /app/update-supabase-creds.sh && \
    echo 'fi' >> /app/update-supabase-creds.sh && \
    echo '' >> /app/update-supabase-creds.sh && \
    echo '# Find the supabase.server.ts file in the build' >> /app/update-supabase-creds.sh && \
    echo 'echo "Directly patching supabase client in built JavaScript..."' >> /app/update-supabase-creds.sh && \
    echo '' >> /app/update-supabase-creds.sh && \
    echo '# Get list of files in build directory' >> /app/update-supabase-creds.sh && \
    echo 'SERVER_DIR="./build/server"' >> /app/update-supabase-creds.sh && \
    echo 'CLIENT_DIR="./build/client"' >> /app/update-supabase-creds.sh && \
    echo '' >> /app/update-supabase-creds.sh && \
    echo '# Directly inject Supabase credentials into all JavaScript files' >> /app/update-supabase-creds.sh && \
    echo 'find "$SERVER_DIR" -name "*.js" -exec sed -i "s|import{createClient}from'"'"'@supabase/supabase-js'"'"'|import{createClient}from'"'"'@supabase/supabase-js'"'"';const HARDCODED_URL='"'"'$SUPABASE_URL'"'"';const HARDCODED_KEY='"'"'$SUPABASE_ANON_KEY'"'"'|g" {} \;' >> /app/update-supabase-creds.sh && \
    echo 'find "$SERVER_DIR" -name "*.js" -exec sed -i "s|const supabaseUrl=process.env.SUPABASE_URL|const supabaseUrl=HARDCODED_URL||process.env.SUPABASE_URL|g" {} \;' >> /app/update-supabase-creds.sh && \
    echo 'find "$SERVER_DIR" -name "*.js" -exec sed -i "s|const supabaseAnonKey=process.env.SUPABASE_ANON_KEY|const supabaseAnonKey=HARDCODED_KEY||process.env.SUPABASE_ANON_KEY|g" {} \;' >> /app/update-supabase-creds.sh && \
    echo '' >> /app/update-supabase-creds.sh && \
    echo 'echo "Supabase credentials have been directly injected into the built JavaScript."' >> /app/update-supabase-creds.sh && \
    chmod +x /app/update-supabase-creds.sh

# Expose application port
EXPOSE 5173

# Production stage
FROM build AS production

# Define environment variables
ARG SESSION_SECRET
ARG SUPABASE_URL
ARG SUPABASE_SERVICE_KEY
ARG SUPABASE_ANON_KEY
ARG NODE_ENV
ARG RUNNING_IN_DOCKER=true

# Set environment variables in the production image
ENV NODE_ENV=${NODE_ENV:-production} \
    RUNNING_IN_DOCKER=${RUNNING_IN_DOCKER} \
    SESSION_SECRET=${SESSION_SECRET} \
    SUPABASE_URL=${SUPABASE_URL} \
    SUPABASE_SERVICE_KEY=${SUPABASE_SERVICE_KEY} \
    SUPABASE_ANON_KEY=${SUPABASE_ANON_KEY}

# Create a comprehensive .env.local file with all possible environment variables
RUN echo "# Environment variables for bolt.diy" > .env.local && \
    echo "SESSION_SECRET=${SESSION_SECRET}" >> .env.local && \
    echo "SUPABASE_URL=${SUPABASE_URL}" >> .env.local && \
    echo "SUPABASE_ANON_KEY=${SUPABASE_ANON_KEY}" >> .env.local && \
    echo "SUPABASE_SERVICE_KEY=${SUPABASE_SERVICE_KEY}" >> .env.local && \
    echo "DATABASE_URL=${DATABASE_URL}" >> .env.local && \
    echo "NODE_ENV=${NODE_ENV:-production}" >> .env.local && \
    echo "RUNNING_IN_DOCKER=true" >> .env.local && \
    echo "DEFAULT_NUM_CTX=${DEFAULT_NUM_CTX}" >> .env.local && \
    echo "GROQ_API_KEY=${GROQ_API_KEY}" >> .env.local && \
    echo "HuggingFace_API_KEY=${HuggingFace_API_KEY}" >> .env.local && \
    echo "OPENAI_API_KEY=${OPENAI_API_KEY}" >> .env.local && \
    echo "ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}" >> .env.local && \
    echo "OPEN_ROUTER_API_KEY=${OPEN_ROUTER_API_KEY}" >> .env.local && \
    echo "GOOGLE_GENERATIVE_AI_API_KEY=${GOOGLE_GENERATIVE_AI_API_KEY}" >> .env.local && \
    echo "OLLAMA_API_BASE_URL=${OLLAMA_API_BASE_URL}" >> .env.local && \
    echo "OPENAI_LIKE_API_BASE_URL=${OPENAI_LIKE_API_BASE_URL}" >> .env.local && \
    echo "OPENAI_LIKE_API_KEY=${OPENAI_LIKE_API_KEY}" >> .env.local && \
    echo "TOGETHER_API_BASE_URL=${TOGETHER_API_BASE_URL}" >> .env.local && \
    echo "TOGETHER_API_KEY=${TOGETHER_API_KEY}" >> .env.local && \
    echo "DEEPSEEK_API_KEY=${DEEPSEEK_API_KEY}" >> .env.local && \
    echo "HYPERBOLIC_API_KEY=${HYPERBOLIC_API_KEY}" >> .env.local && \
    echo "HYPERBOLIC_API_BASE_URL=${HYPERBOLIC_API_BASE_URL}" >> .env.local && \
    echo "MISTRAL_API_KEY=${MISTRAL_API_KEY}" >> .env.local && \
    echo "COHERE_API_KEY=${COHERE_API_KEY}" >> .env.local && \
    echo "LMSTUDIO_API_BASE_URL=${LMSTUDIO_API_BASE_URL}" >> .env.local && \
    echo "XAI_API_KEY=${XAI_API_KEY}" >> .env.local && \
    echo "PERPLEXITY_API_KEY=${PERPLEXITY_API_KEY}" >> .env.local && \
    echo "AWS_BEDROCK_CONFIG=${AWS_BEDROCK_CONFIG}" >> .env.local && \
    echo "VITE_LOG_LEVEL=${VITE_LOG_LEVEL:-debug}" >> .env.local

# Create .dev.vars file for Wrangler Pages
RUN echo "Creating .dev.vars file for Wrangler Pages" && \
    echo "SESSION_SECRET=${SESSION_SECRET}" > .dev.vars && \
    echo "SUPABASE_URL=${SUPABASE_URL}" >> .dev.vars && \
    echo "SUPABASE_ANON_KEY=${SUPABASE_ANON_KEY}" >> .dev.vars && \
    echo "SUPABASE_SERVICE_KEY=${SUPABASE_SERVICE_KEY}" >> .dev.vars && \
    echo "DATABASE_URL=${DATABASE_URL}" >> .dev.vars && \
    echo "Created .dev.vars with SESSION_SECRET, SUPABASE_URL, SUPABASE_ANON_KEY, SUPABASE_SERVICE_KEY and DATABASE_URL for local development"

# Create session-data directory with proper permissions
RUN mkdir -p /app/session-data && \
    chmod 777 /app/session-data

# Use the entrypoint script to ensure the secret is set before startup
ENTRYPOINT ["/app/entrypoint.sh"]
